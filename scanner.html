<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatWar Universal Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* –•–ï–î–ï–† –° –°–¢–ê–¢–ò–°–¢–ò–ö–û–ô */
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 42px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        /* –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò */
        .global-settings {
            background: #f8f9fa;
            border-bottom: 3px solid #3498db;
            padding: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .settings-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .settings-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        /* –¢–ê–ë–´ –¢–ò–ü–û–í –ö–û–ù–¢–ï–ù–¢–ê */
        .content-tabs {
            display: flex;
            background: #34495e;
            padding: 0;
            border-bottom: 3px solid #3498db;
            flex-wrap: wrap;
        }
        
        .content-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;
        }
        
        .content-tab:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .content-tab.active {
            background: #3498db;
        }
        
        /* –°–ï–ö–¶–ò–ò */
        .section {
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .scan-controls {
            background: #e8f6f3;
            border: 1px solid #1abc9c;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .settings-row > div {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        /* –í–ï–†–°–ò–ò –ö–û–°–¢–Æ–ú–û–í */
        .costume-versions {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .success-rate { color: #27ae60; }
        .check-rate { color: #f39c12; }
        .speed-rate { color: #3498db; }
        
        .log {
            height: 150px;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            line-height: 1.4;
        }
        
        .log-success { color: #2ecc71; }
        .log-info { color: #3498db; }
        .log-warning { color: #f39c12; }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í */
        .results-container {
            margin-top: 20px;
            border: 2px dashed #27ae60;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
            display: none;
        }
        
        .preview-container {
            margin-top: 20px;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .preview-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }
        
        .preview-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .preview-image {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            background: white;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .preview-image:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        
        .preview-image img {
            max-width: 100%;
            max-height: 120px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .preview-image .image-info {
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }
        
        .preview-image .image-id {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .toggle-preview {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .export-options {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .format-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .format-btn {
            padding: 10px 15px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .format-btn.active {
            background: #3498db;
            color: white;
        }

        .archive-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .archive-success h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .domain-selector {
            background: #e8f6f3;
            border: 1px solid #1abc9c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .domain-buttons {
            display: flex;
            gap: 10px;
        }
        
        .domain-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #1abc9c;
            background: white;
            color: #1abc9c;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .domain-btn.active {
            background: #1abc9c;
            color: white;
        }

        /* –ù–ê–°–¢–†–û–ô–ö–ò –°–ö–û–†–û–°–¢–ò */
        .speed-controls {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
        }

        .speed-presets {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .speed-btn {
            padding: 8px 12px;
            border: 2px solid #f39c12;
            background: white;
            color: #f39c12;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 12px;
        }

        .speed-btn.active {
            background: #f39c12;
            color: white;
        }

        .speed-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 12px;
            color: #2c3e50;
        }

        /* –ù–ê–°–¢–†–û–ô–ö–ò –ò–ú–ï–ù –§–ê–ô–õ–û–í */
        .naming-options {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .naming-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .naming-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #9b59b6;
            background: white;
            color: #9b59b6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            min-width: 150px;
        }

        .naming-btn.active {
            background: #9b59b6;
            color: white;
        }

        .naming-preview {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 11px;
            color: #2c3e50;
            font-family: monospace;
        }

        /* –¢–ï–ö–£–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò –ë–ê–î–ñ–ò */
        .current-settings {
            background: #e8f4fd;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin: 0 25px 20px 25px;
            text-align: center;
        }

        .current-settings h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .settings-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 0 5px;
            font-weight: 600;
        }

        .settings-badge.domain { background: #1abc9c; }
        .settings-badge.naming { background: #9b59b6; }
        .settings-badge.format { background: #3498db; }
        .settings-badge.speed { background: #f39c12; }

/* –î–û–ë–ê–í–¨–¢–ï –í –ö–û–ù–ï–¶ CSS –°–¢–ò–õ–ï–ô */

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–µ–≤—å—é */
.preview-image {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* –°—Ç–∏–ª—å –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.preview-images:empty::before {
    content: "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ... –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å";
    text-align: center;
    color: #666;
    padding: 40px 20px;
    display: block;
    font-style: italic;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- –•–ï–î–ï–† –° –°–¢–ê–¢–ò–°–¢–ò–ö–û–ô -->
        <div class="header">
            <h1>üé≠ CatWar Universal Scanner</h1>
            <p>–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ CatWar</p>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="totalScanned">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastScan">-</div>
                    <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalFound">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                </div>
            </div>
        </div>

        <!-- –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="global-settings">
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞</h3>
                    <div class="domain-selector">
                        <div class="domain-buttons">
                            <button class="domain-btn active" onclick="switchDomain('catwar.net')">catwar.net</button>
                            <button class="domain-btn" onclick="switchDomain('catwar.su')">catwar.su</button>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏</h3>
                    <div class="speed-controls">
                        <div class="speed-presets">
                            <button class="speed-btn active" onclick="setSpeedPreset(500, 100, 5000)">üê¢ –ú–µ–¥–ª–µ–Ω–Ω–æ</button>
                            <button class="speed-btn" onclick="setSpeedPreset(200, 50, 3000)">üö∂ –û–±—ã—á–Ω–æ</button>
                            <button class="speed-btn" onclick="setSpeedPreset(100, 20, 2000)">üöÄ –ë—ã—Å—Ç—Ä–æ</button>
                            <button class="speed-btn" onclick="setSpeedPreset(50, 10, 1000)">‚ö° –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ</button>
                            <button class="speed-btn" onclick="setSpeedPreset(10, 5, 500)">üí® –ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å</button>
                        </div>
                        <div class="speed-info">
                            –ó–∞–¥–µ—Ä–∂–∫–∞: <span id="currentDelay">200</span>–º—Å | –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ: <span id="currentPauseAfter">50</span> –∑–∞–ø—Ä–æ—Å–æ–≤ | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑—ã: <span id="currentPauseDuration">3000</span>–º—Å
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üìù –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤</h3>
                    <div class="naming-options">
                        <div class="naming-buttons">
                            <button class="naming-btn active" onclick="setFileNameFormat('type_id')">–¢–∏–ø_ID (costume_1.png)</button>
                            <button class="naming-btn" onclick="setFileNameFormat('catwar_type_id')">CatWar_—Ç–∏–ø_ID (CatWar_costume_1.png)</button>
                            <button class="naming-btn" onclick="setFileNameFormat('id_only')">–¢–æ–ª—å–∫–æ ID (1.png)</button>
                        </div>
                        <div class="naming-preview" id="namingPreview">
                            –ü—Ä–∏–º–µ—Ä: costume_1.png
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üíæ –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞</h3>
                    <div class="export-options">
                        <div class="format-buttons">
                            <button class="format-btn active" onclick="setExportFormat('zip')">üì¶ ZIP –∞—Ä—Ö–∏–≤</button>
                            <button class="format-btn" onclick="setExportFormat('png')">üñºÔ∏è PNG —Ñ–∞–π–ª—ã</button>
                            <button class="format-btn" onclick="setExportFormat('jpg')">üñºÔ∏è JPG —Ñ–∞–π–ª—ã</button>
                            <button class="format-btn" onclick="setExportFormat('json')">üìã JSON —Å–ø–∏—Å–æ–∫</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–ï–ö–£–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="current-settings">
            <h4>üìã –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
            <div>
                <span class="settings-badge domain" id="currentDomainBadge">catwar.net</span>
                <span class="settings-badge naming" id="currentNamingBadge">–¢–∏–ø_ID</span>
                <span class="settings-badge format" id="currentFormatBadge">ZIP</span>
                <span class="settings-badge speed" id="currentSpeedBadge">–û–±—ã—á–Ω–æ</span>
            </div>
        </div>

        <!-- –¢–ê–ë–´ –¢–ò–ü–û–í –ö–û–ù–¢–ï–ù–¢–ê -->
        <div class="content-tabs">
            <button class="content-tab active" data-type="costume">
                üé≠ –ö–æ—Å—Ç—é–º—ã
            </button>
            <button class="content-tab" data-type="spacoj">
                üé® –§–æ–Ω—ã
            </button>
            <button class="content-tab" data-type="odoroj">
                üëÉ –ó–∞–ø–∞—Ö–∏
            </button>
            <button class="content-tab" data-type="actions">
                üé¨ –î–µ–π—Å—Ç–≤–∏—è
            </button>
            <button class="content-tab" data-type="achievement">
                üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </button>
            <button class="content-tab" data-type="medal">
                ü•á –ú–µ–¥–∞–ª–∏
            </button>
            <button class="content-tab" data-type="things">
                üéí –ü—Ä–µ–¥–º–µ—Ç—ã
            </button>
        </div>
        
        <!-- –°–ï–ö–¶–ò–Ø –°–ö–ê–ù–ï–†–ê -->
        <div class="section">
            <div class="section-title">üîç –°–∫–∞–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - <span id="currentTypeName">–ö–æ—Å—Ç—é–º—ã</span></div>
            
            <div class="scan-controls">
                <!-- –í–ï–†–°–ò–ò –ö–û–°–¢–Æ–ú–û–í -->
                <div class="costume-versions" id="costumeVersionsContainer">
                    <strong>üé≠ –í–µ—Ä—Å–∏–∏ –∫–æ—Å—Ç—é–º–æ–≤:</strong>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="costumeVersion" value="0" checked> 0 (—Å—Ç–æ—è—á–∞—è)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="costumeVersion" value="1"> 1 (—Å–ø—è—â–∞—è)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="costumeVersion" value="-1"> -1 (–∫–æ—Ç—è—á—å—è)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="costumeVersion" value="5"> 5 (–ø—å—é—â–∞—è)
                        </label>
                    </div>
                </div>

                <div class="settings-row">
                    <div>
                        <label>ID –æ—Ç:</label>
                        <input type="number" id="startId" value="1" min="1">
                    </div>
                    <div>
                        <label>ID –¥–æ:</label>
                        <input type="number" id="endId" value="20" min="1">
                    </div>
                    <div>
                        <label>–ó–∞–¥–µ—Ä–∂–∫–∞ (–º—Å):</label>
                        <input type="number" id="delay" value="200" min="0" max="5000">
                    </div>
                </div>
                
                <div class="settings-row">
                    <div>
                        <label>–†–µ–∂–∏–º –ø—Ä–µ–≤—å—é:</label>
                        <select id="previewMode">
                            <option value="images">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</option>
                            <option value="list">üìã –°–ø–∏—Å–æ–∫ ID</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div>
                        <label>–ü–∞—É–∑–∞ –ø–æ—Å–ª–µ:</label>
                        <input type="number" id="pauseAfter" value="50" min="10" max="200">
                    </div>
                    <div>
                        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑—ã (–º—Å):</label>
                        <input type="number" id="pauseDuration" value="3000" min="1000" max="10000">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="startScan()">üöÄ –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                    <button class="btn btn-warning" onclick="quickTest()">‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (1-20)</button>
                    <button class="btn" onclick="resumeScan()">üîÅ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                    <button class="btn btn-danger" onclick="stopScan()" id="stopBtn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <div>
                        <strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> <span id="statusText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                    </div>
                    <div>
                        <span id="progressText">0/0</span>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <!-- –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value check-rate" id="checkedCount">0</div>
                        <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value success-rate" id="foundCount">0</div>
                        <div class="stat-label">–ù–∞–π–¥–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentSuccessRate">0%</div>
                        <div class="stat-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value speed-rate" id="speedRate">0/—Å</div>
                        <div class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å</div>
                    </div>
                </div>

                <div class="log" id="logContainer"></div>
            </div>

            <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
            <div class="results-container" id="resultsContainer">
                <div class="preview-container">
                    <div class="preview-title">üëÅÔ∏è –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - <span id="resultsTypeName">–ö–æ—Å—Ç—é–º—ã</span></div>
                    
                    <div class="preview-controls">
                        <div>
                            <strong>–ù–∞–π–¥–µ–Ω–æ: <span id="previewCount">0</span> —Ñ–∞–π–ª–æ–≤</strong>
                        </div>
                        <div>
                            <button class="toggle-preview" onclick="togglePreviewMode()" id="previewModeBtn">üìã –°–ø–∏—Å–æ–∫ ID</button>
                            <button class="toggle-preview" onclick="loadAllPreviews()">üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ</button>
                            <button class="toggle-preview" onclick="exportResults()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                            <button class="toggle-preview" onclick="clearPreviews()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="preview-images" id="previewImages">
                        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                    </div>
                </div>
            </div>

            <!-- –£–°–ü–ï–®–ù–û–ï –°–û–ó–î–ê–ù–ò–ï –ê–†–•–ò–í–ê -->
            <div class="archive-success" id="archiveSuccess">
                <h3>üéâ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h3>
                <p id="archiveInfo">–§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã</p>
                <button class="btn btn-success" onclick="document.getElementById('archiveSuccess').style.display = 'none'">OK</button>
            </div>
        </div>
        
        <!-- –°–ï–ö–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
        <div class="section">
            <div class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div style="text-align: center; padding: 20px; color: #666;">
                <p>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>
                <div class="stats" style="max-width: 800px; margin: 20px auto;">
                    <div class="stat-card">
                        <div class="stat-value" id="statsTotalScanned">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statsTotalFound">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statsSuccessRate">0%</div>
                        <div class="stat-label">–û–±—â–∞—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statsAvgSpeed">0/—Å</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>CatWar Universal Scanner v2.8 | –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å + –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
        </div>
    </div>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let currentScanType = 'costume';
        let isScanning = false;
        let scanResults = new Set();
        let foundImages = new Map();
        let startTime = 0;
        let totalChecked = 0;
        let totalFound = 0;
        let currentProxyIndex = 0;
        let requestCount = 0;
        let previewMode = 'images';
        let globalStats = {
            totalScanned: 0,
            totalFound: 0,
            totalTime: 0
        };
        let currentDomain = 'catwar.net';
        let exportFormat = 'zip';
        let fileNameFormat = 'type_id';
        let lastSpeedUpdate = 0;
        let requestsPerSecond = 0;
        let requestCounter = 0;

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¢–ò–ü–û–í –ö–û–ù–¢–ï–ù–¢–ê
        const CONTENT_TYPES = {
            costume: { name: '–ö–æ—Å—Ç—é–º—ã', path: 'cats/{X}/costume/', extension: 'png', baseUrl: 'cw3/' },
            spacoj: { name: '–§–æ–Ω—ã', path: 'spacoj/', extension: 'jpg', baseUrl: 'cw3/' },
            odoroj: { name: '–ó–∞–ø–∞—Ö–∏', path: 'odoroj/', extension: 'png', baseUrl: 'cw3/' },
            actions: { name: '–î–µ–π—Å—Ç–≤–∏—è', path: 'actions/', extension: 'png', baseUrl: 'cw3/' },
            achievement: { name: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', path: 'achievement/', extension: 'png', baseUrl: '' },
            medal: { name: '–ú–µ–¥–∞–ª–∏', path: 'medal/', extension: 'png', baseUrl: '' },
            things: { name: '–ü—Ä–µ–¥–º–µ—Ç—ã', path: 'things/', extension: 'png', baseUrl: 'cw3/' }
        };

        // CORS –ü–†–û–ö–°–ò
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://cors-anywhere.herokuapp.com/'
        ];

        // üîß –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ù–ê–°–¢–†–û–ô–ö–ê–ú–ò
        function switchDomain(domain) {
            document.querySelectorAll('.domain-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentDomain = domain;
            updateCurrentSettingsBadges();
            addLog(`üåê –î–æ–º–µ–Ω –∏–∑–º–µ–Ω–µ–Ω: ${currentDomain}`, 'info');
        }

        function setFileNameFormat(format) {
            document.querySelectorAll('.naming-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            fileNameFormat = format;
            updateNamingPreview();
            updateCurrentSettingsBadges();
            addLog(`üìù –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω: ${getFileNameFormatName()}`, 'info');
        }

        function getFileNameFormatName() {
            switch(fileNameFormat) {
                case 'type_id': return '–¢–∏–ø_ID';
                case 'catwar_type_id': return 'CatWar_—Ç–∏–ø_ID';
                case 'id_only': return '–¢–æ–ª—å–∫–æ ID';
                default: return '–¢–∏–ø_ID';
            }
        }

        function updateNamingPreview() {
            const preview = document.getElementById('namingPreview');
            let example = '';
            
            switch(fileNameFormat) {
                case 'type_id':
                    example = 'costume_1.png';
                    break;
                case 'catwar_type_id':
                    example = 'CatWar_costume_1.png';
                    break;
                case 'id_only':
                    example = '1.png';
                    break;
            }
            
            preview.textContent = `–ü—Ä–∏–º–µ—Ä: ${example}`;
        }

        function setExportFormat(format) {
            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            exportFormat = format;
            updateCurrentSettingsBadges();
            addLog(`üíæ –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞: ${format.toUpperCase()}`, 'info');
        }

        function setSpeedPreset(delay, pauseAfter, pauseDuration) {
            document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('delay').value = delay;
            document.getElementById('pauseAfter').value = pauseAfter;
            document.getElementById('pauseDuration').value = pauseDuration;
            
            updateSpeedDisplay();
            updateCurrentSettingsBadges();
            addLog(`‚ö° –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–µ—Å–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏: –∑–∞–¥–µ—Ä–∂–∫–∞ ${delay}–º—Å`, 'info');
        }

        function updateSpeedDisplay() {
            document.getElementById('currentDelay').textContent = document.getElementById('delay').value;
            document.getElementById('currentPauseAfter').textContent = document.getElementById('pauseAfter').value;
            document.getElementById('currentPauseDuration').textContent = document.getElementById('pauseDuration').value;
        }

        function updateCurrentSettingsBadges() {
            document.getElementById('currentDomainBadge').textContent = currentDomain;
            document.getElementById('currentNamingBadge').textContent = getFileNameFormatName();
            document.getElementById('currentFormatBadge').textContent = exportFormat.toUpperCase();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ—Å–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
            const delay = parseInt(document.getElementById('delay').value);
            let speedPreset = '–û–±—ã—á–Ω–æ';
            if (delay <= 10) speedPreset = '–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å';
            else if (delay <= 50) speedPreset = '–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ';
            else if (delay <= 100) speedPreset = '–ë—ã—Å—Ç—Ä–æ';
            else if (delay <= 200) speedPreset = '–û–±—ã—á–Ω–æ';
            else speedPreset = '–ú–µ–¥–ª–µ–Ω–Ω–æ';
            
            document.getElementById('currentSpeedBadge').textContent = speedPreset;
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentScanType = this.dataset.type;
                    
                    document.getElementById('currentTypeName').textContent = CONTENT_TYPES[currentScanType].name;
                    document.getElementById('resultsTypeName').textContent = CONTENT_TYPES[currentScanType].name;
                    
                    document.getElementById('costumeVersionsContainer').style.display = 
                        currentScanType === 'costume' ? 'block' : 'none';
                    
                    updateRangePresets();
                    addLog(`üîÅ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞: ${CONTENT_TYPES[currentScanType].name}`, 'info');
                });
            });

            document.getElementById('previewMode').addEventListener('change', function() {
                previewMode = this.value;
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
            document.getElementById('delay').addEventListener('input', updateSpeedDisplay);
            document.getElementById('pauseAfter').addEventListener('input', updateSpeedDisplay);
            document.getElementById('pauseDuration').addEventListener('input', updateSpeedDisplay);

            updateRangePresets();
            updateGlobalStats();
            updateSpeedDisplay();
            updateNamingPreview();
            updateCurrentSettingsBadges();
            addLog('üîß –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä CatWar –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!', 'info');
        });

        function updateRangePresets() {
            const presets = {
                costume: { start: 1, end: 20 },
                spacoj: { start: 1, end: 20 },
                odoroj: { start: 1, end: 20 },
                actions: { start: 1, end: 20 },
                achievement: { start: 1, end: 20 },
                medal: { start: 1, end: 20 },
                things: { start: 1, end: 20 }
            };
            
            const preset = presets[currentScanType];
            document.getElementById('startId').value = preset.start;
            document.getElementById('endId').value = preset.end;
        }

        // üîß –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø
        async function startScan() {
            const startId = parseInt(document.getElementById('startId').value);
            const endId = parseInt(document.getElementById('endId').value);
            
            if (startId >= endId) {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω ID');
                return;
            }

            await startScanning(startId, endId);
        }

        async function resumeScan() {
            const lastId = Array.from(scanResults).pop() || parseInt(document.getElementById('startId').value);
            document.getElementById('startId').value = lastId + 1;
            document.getElementById('endId').value = lastId + 100;
            await startScanning(lastId + 1, lastId + 100);
        }

        async function startScanning(startId, endId) {
            if (isScanning) return;

            isScanning = true;
            scanResults.clear();
            foundImages.clear();
            totalChecked = 0;
            totalFound = 0;
            requestCount = 0;
            requestCounter = 0;
            startTime = Date.now();
            lastSpeedUpdate = Date.now();
            currentProxyIndex = 0;
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('previewImages').innerHTML = '';
            
            const total = calculateTotalRequests(startId, endId);
            updateProgress(0, total);
            addLog(`üöÄ –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${CONTENT_TYPES[currentScanType].name} (${startId}-${endId})`, 'info');
            addLog(`üìä –û–∂–∏–¥–∞–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${total} –∑–∞–ø—Ä–æ—Å–æ–≤`, 'info');
            addLog(`‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏: –∑–∞–¥–µ—Ä–∂–∫–∞ ${document.getElementById('delay').value}–º—Å`, 'info');
            addLog(`üåê –î–æ–º–µ–Ω: ${currentDomain}`, 'info');
            addLog(`üìù –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω: ${getFileNameFormatName()}`, 'info');

            // üîß –¢–û–õ–¨–ö–û –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø
            await scanSequential(startId, endId, total);

            if (isScanning) {
                finishScanning();
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–î–°–ß–ï–¢ –û–ë–©–ï–ì–û –ö–û–õ–ò–ß–ï–°–¢–í–ê –ó–ê–ü–†–û–°–û–í
        function calculateTotalRequests(startId, endId) {
            if (currentScanType === 'costume') {
                const versions = Array.from(document.querySelectorAll('input[name="costumeVersion"]:checked'))
                    .map(input => input.value);
                return (endId - startId + 1) * versions.length;
            } else {
                return endId - startId + 1;
            }
        }

        async function scanSequential(startId, endId, total) {
            const delay = parseInt(document.getElementById('delay').value);
            const pauseAfter = parseInt(document.getElementById('pauseAfter').value);
            const pauseDuration = parseInt(document.getElementById('pauseDuration').value);
            
            let currentProgress = 0;
            
            for (let id = startId; id <= endId && isScanning; id++) {
                await processContentId(id);
                currentProgress = calculateCurrentProgress(id, startId, total);
                updateProgress(currentProgress, total);
                
                requestCount++;
                requestCounter++;
                updateSpeedStats();
                
                if (requestCount >= pauseAfter && isScanning) {
                    addLog(`‚è∏Ô∏è –ü–∞—É–∑–∞ ${pauseDuration/1000}—Å–µ–∫ –ø–æ—Å–ª–µ ${requestCount} –∑–∞–ø—Ä–æ—Å–æ–≤`, 'warning');
                    await new Promise(resolve => setTimeout(resolve, pauseDuration));
                    requestCount = 0;
                    rotateProxy();
                }
                
                if (delay > 0 && isScanning) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // üîß –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ö–û–†–û–°–¢–ò
        function updateSpeedStats() {
            const now = Date.now();
            const timePassed = (now - lastSpeedUpdate) / 1000;
            
            if (timePassed >= 1) {
                requestsPerSecond = Math.round(requestCounter / timePassed);
                requestCounter = 0;
                lastSpeedUpdate = now;
                document.getElementById('speedRate').textContent = requestsPerSecond + '/—Å';
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–î–°–ß–ï–¢ –¢–ï–ö–£–©–ï–ì–û –ü–†–û–ì–†–ï–°–°–ê
        function calculateCurrentProgress(currentId, startId, total) {
            if (currentScanType === 'costume') {
                const versions = Array.from(document.querySelectorAll('input[name="costumeVersion"]:checked')).length;
                return Math.min((currentId - startId + 1) * versions, total);
            } else {
                return currentId - startId + 1;
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–°–¢–Æ–ú–û–í
        async function processContentId(id) {
            const typeConfig = CONTENT_TYPES[currentScanType];
            
            if (currentScanType === 'costume') {
                const versions = Array.from(document.querySelectorAll('input[name="costumeVersion"]:checked'))
                    .map(input => input.value);
                
                if (versions.length === 0) {
                    addLog('‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∫–æ—Å—Ç—é–º–∞', 'warning');
                    return;
                }
                
                for (const version of versions) {
                    totalChecked++;
                    const url = `https://${currentDomain}/${typeConfig.baseUrl}${typeConfig.path.replace('{X}', version)}${id}.${typeConfig.extension}`;
                    await checkImage(url, id, version);
                }
            } else {
                totalChecked++;
                const url = `https://${currentDomain}/${typeConfig.baseUrl}${typeConfig.path}${id}.${typeConfig.extension}`;
                await checkImage(url, id);
            }
            
            updateStats();
        }

// üîß –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –° –§–ò–ö–°–û–ú –î–õ–Ø –î–û–°–¢–ò–ñ–ï–ù–ò–ô, –ó–ê–ü–ê–•–û–í –ò –î–ï–ô–°–¢–í–ò–ô
async function checkImage(url, id, version = null) {
    for (let attempt = 0; attempt < CORS_PROXIES.length; attempt++) {
        try {
            const proxyUrl = getProxyUrl(url);
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                    'Accept': 'image/*, */*'
                }
            });
            
            if (response.ok) {
                const blob = await response.blob();
                
                // üîß –§–ò–ö–°: –¢–û–õ–¨–ö–û –§–ê–ô–õ–´ –†–ê–ó–ú–ï–†–û–ú 305B –°–ß–ò–¢–ê–Æ–¢–°–Ø –ù–ï–í–ê–õ–ò–î–ù–´–ú–ò
                let isValid = true;
                
                // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –†–û–í–ù–û 305 –±–∞–π—Ç - —Å—á–∏—Ç–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
                if (blob.size === 305) {
                    isValid = false;
                }
                // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã (–º–µ–Ω—å—à–µ –∏–ª–∏ –±–æ–ª—å—à–µ 305B) - –≤–∞–ª–∏–¥–Ω—ã–µ
                else {
                    isValid = true;
                }
                
                if (isValid) {
                    const blobUrl = URL.createObjectURL(blob);
                    const contentData = {
                        id: id,
                        url: url,
                        blob: blob,
                        blobUrl: blobUrl,
                        timestamp: new Date().toISOString(),
                        type: currentScanType,
                        version: version,
                        size: blob.size
                    };
                    
                    // üîß –£–ù–ò–ö–ê–õ–¨–ù–´–ô –ö–õ–Æ–ß –î–õ–Ø –ö–û–°–¢–Æ–ú–û–í –° –ü–†–ê–í–ò–õ–¨–ù–û–ô –°–û–†–¢–ò–†–û–í–ö–û–ô
                    const uniqueKey = version !== null ? 
                        `costume_${String(id).padStart(6, '0')}_v${version}` : 
                        `${currentScanType}_${String(id).padStart(6, '0')}`;
                    
                    foundImages.set(uniqueKey, contentData);
                    scanResults.add(id);
                    totalFound++;
                    
                    addLog(`‚úÖ –ù–∞–π–¥–µ–Ω: ${CONTENT_TYPES[currentScanType].name} #${id}${version ? ` (v${version})` : ''} [${blob.size} –±–∞–π—Ç]`, 'success');
                    
                    // üîß –°–†–ê–ó–£ –î–û–ë–ê–í–õ–Ø–ï–ú –í –ü–†–ï–í–¨–Æ –ï–°–õ–ò –†–ï–ñ–ò–ú –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
                    if (previewMode === 'images') {
                        addPreview(uniqueKey, contentData);
                    }
                    
                    updateStats();
                    return;
                } else {
                    addLog(`‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä (305B): ${CONTENT_TYPES[currentScanType].name} #${id}`, 'error');
                }
            }
        } catch (error) {
            // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ–∫—Å–∏
        }
        
        rotateProxy();
    }
}

        function finishScanning() {
            isScanning = false;
            document.getElementById('stopBtn').disabled = true;
            
            const scanTime = Math.round((Date.now() - startTime) / 1000);
            showResults(scanTime);
            updateGlobalStats();
            
            addLog(`üéâ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ù–∞–π–¥–µ–Ω–æ: ${totalFound} —Ñ–∞–π–ª–æ–≤ –∑–∞ ${scanTime} —Å–µ–∫—É–Ω–¥`, 'info');
            addLog(`‚ö° –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å: ${Math.round(totalChecked / scanTime)} –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫`, 'info');
        }

        function showResults(scanTime) {
            document.getElementById('resultsContainer').style.display = 'block';
            
            const foundArray = Array.from(foundImages.keys()).sort();
            
            document.getElementById('previewCount').textContent = foundArray.length;
            
            // üîß –°–†–ê–ó–£ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–†–ï–í–¨–Æ
            showPreviews(foundArray);
        }

        function showPreviews(foundKeys) {
            const previewContainer = document.getElementById('previewImages');
            
            if (previewMode === 'list') {
                showIdList(foundKeys);
            } else {
                loadPreviewsFromBlobs(foundKeys);
            }
        }

        function showIdList(foundKeys) {
            const previewContainer = document.getElementById('previewImages');
            let html = '';
            
            // üîß –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê –ü–û ID
            const sortedKeys = [...foundKeys].sort((a, b) => {
                const getNumericId = (key) => {
                    const match = key.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                };
                return getNumericId(a) - getNumericId(b);
            });
            
            sortedKeys.forEach(key => {
                const imageData = foundImages.get(key);
                html += `
                    <div class="preview-image">
                        <div class="image-info">
                            <div class="image-id">#${imageData.id}${imageData.version ? ` (v${imageData.version})` : ''}</div>
                            <div>${CONTENT_TYPES[currentScanType].name}</div>
                            <div style="font-size: 10px; color: #666;">${imageData.size} –±–∞–π—Ç</div>
                            <button class="toggle-preview" onclick="loadSinglePreview('${key}')" style="margin-top: 5px; padding: 3px 8px; font-size: 10px;">üñºÔ∏è –ü—Ä–µ–≤—å—é</button>
                        </div>
                    </div>
                `;
            });
            
            previewContainer.innerHTML = html;
        }

        function loadPreviewsFromBlobs(keys) {
            const previewContainer = document.getElementById('previewImages');
            let html = '';
            let loadedCount = 0;

            // üîß –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê –ü–û ID
            const sortedKeys = [...keys].sort((a, b) => {
                const getNumericId = (key) => {
                    const match = key.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                };
                return getNumericId(a) - getNumericId(b);
            });

            sortedKeys.forEach(key => {
                const imageData = foundImages.get(key);
                
                if (imageData && imageData.blobUrl) {
                    html += `
                        <div class="preview-image" data-id="${key}">
                            <img src="${imageData.blobUrl}" alt="${CONTENT_TYPES[currentScanType].name} #${imageData.id}">
                            <div class="image-info">
                                <div class="image-id">#${imageData.id}${imageData.version ? ` (v${imageData.version})` : ''}</div>
                                <div>${CONTENT_TYPES[currentScanType].name}</div>
                                <div style="font-size: 10px; color: #666;">${imageData.size} –±–∞–π—Ç</div>
                            </div>
                        </div>
                    `;
                    loadedCount++;
                }
            });

            if (loadedCount > 0) {
                previewContainer.innerHTML = html;
            } else {
                previewContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–≤—å—é</div>';
            }
        }

// üîß –§–£–ù–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–†–ï–í–¨–Æ –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
function addPreview(key, contentData) {
    const previewContainer = document.getElementById('previewImages');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω —Å–∫—Ä—ã—Ç
    document.getElementById('resultsContainer').style.display = 'block';
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ..." –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
    if (previewContainer.innerHTML.includes('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ')) {
        previewContainer.innerHTML = '';
    }
    
    if (previewMode === 'images') {
        // –†–µ–∂–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
        if (contentData && contentData.blobUrl) {
            const previewHtml = `
                <div class="preview-image" data-id="${key}">
                    <img src="${contentData.blobUrl}" alt="${CONTENT_TYPES[currentScanType].name} #${contentData.id}">
                    <div class="image-info">
                        <div class="image-id">#${contentData.id}${contentData.version ? ` (v${contentData.version})` : ''}</div>
                        <div>${CONTENT_TYPES[currentScanType].name}</div>
                        <div style="font-size: 10px; color: #666;">${contentData.size} –±–∞–π—Ç</div>
                    </div>
                </div>
            `;
            
            // üîß –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø—Ä–µ–≤—å—é –≤ –∫–æ–Ω–µ—Ü –¥–ª—è –ø–æ—Ä—è–¥–∫–∞ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É
            previewContainer.insertAdjacentHTML('beforeend', previewHtml);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            document.getElementById('previewCount').textContent = foundImages.size;
            
            // üîß –ü–†–û–ö–†–£–¢–ò–ú –í–ù–ò–ó –ö –ù–û–í–û–ú–£ –≠–õ–ï–ú–ï–ù–¢–£
            previewContainer.scrollTop = previewContainer.scrollHeight;
        }
    } else {
        // –†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
        showIdList(Array.from(foundImages.keys()));
    }
}

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ù–ê–ß–ê–õ–ê –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø
async function startScanning(startId, endId) {
    if (isScanning) return;

    isScanning = true;
    scanResults.clear();
    foundImages.clear();
    totalChecked = 0;
    totalFound = 0;
    requestCount = 0;
    requestCounter = 0;
    startTime = Date.now();
    lastSpeedUpdate = Date.now();
    currentProxyIndex = 0;
    
    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'block';
    document.getElementById('stopBtn').disabled = false;
    
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–µ –æ—á–∏—â–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é, –∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ
    const previewContainer = document.getElementById('previewImages');
    previewContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ... –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>';
    document.getElementById('previewCount').textContent = '0';
    
    const total = calculateTotalRequests(startId, endId);
    updateProgress(0, total);
    addLog(`üöÄ –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${CONTENT_TYPES[currentScanType].name} (${startId}-${endId})`, 'info');
    addLog(`üìä –û–∂–∏–¥–∞–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${total} –∑–∞–ø—Ä–æ—Å–æ–≤`, 'info');
    addLog(`‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏: –∑–∞–¥–µ—Ä–∂–∫–∞ ${document.getElementById('delay').value}–º—Å`, 'info');
    addLog(`üåê –î–æ–º–µ–Ω: ${currentDomain}`, 'info');
    addLog(`üìù –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω: ${getFileNameFormatName()}`, 'info');
    addLog(`üëÅÔ∏è –ü—Ä–µ–≤—å—é –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏`, 'info');

    // üîß –¢–û–õ–¨–ö–û –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø
    await scanSequential(startId, endId, total);

    if (isScanning) {
        finishScanning();
    }
}

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–ö–ê–ó–ê –°–ü–ò–°–ö–ê ID (–î–õ–Ø –†–ï–ê–õ–¨–ù–û–ì–û –í–†–ï–ú–ï–ù–ò)
function showIdList(foundKeys) {
    const previewContainer = document.getElementById('previewImages');
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ..." –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    if (previewContainer.innerHTML.includes('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ')) {
        previewContainer.innerHTML = '';
    }
    
    let html = '';
    
    // üîß –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê –ü–û ID
    const sortedKeys = [...foundKeys].sort((a, b) => {
        const getNumericId = (key) => {
            const match = key.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        };
        return getNumericId(a) - getNumericId(b);
    });
    
    sortedKeys.forEach(key => {
        const imageData = foundImages.get(key);
        html += `
            <div class="preview-image">
                <div class="image-info">
                    <div class="image-id">#${imageData.id}${imageData.version ? ` (v${imageData.version})` : ''}</div>
                    <div>${CONTENT_TYPES[currentScanType].name}</div>
                    <div style="font-size: 10px; color: #666;">${imageData.size} –±–∞–π—Ç</div>
                    <button class="toggle-preview" onclick="loadSinglePreview('${key}')" style="margin-top: 5px; padding: 3px 8px; font-size: 10px;">üñºÔ∏è –ü—Ä–µ–≤—å—é</button>
                </div>
            </div>
        `;
    });
    
    previewContainer.innerHTML = html;
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    document.getElementById('previewCount').textContent = foundImages.size;
}

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –†–ï–ñ–ò–ú–ê –ü–†–ï–í–¨–Æ
function togglePreviewMode() {
    previewMode = previewMode === 'images' ? 'list' : 'images';
    const button = document.getElementById('previewModeBtn');
    button.textContent = previewMode === 'images' ? 'üìã –°–ø–∏—Å–æ–∫ ID' : 'üñºÔ∏è –ü—Ä–µ–≤—å—é';
    
    const foundKeys = Array.from(foundImages.keys()).sort((a, b) => {
        const getNumericId = (key) => {
            const match = key.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        };
        return getNumericId(a) - getNumericId(b);
    });
    
    if (foundKeys.length === 0) {
        // –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –µ—â–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        document.getElementById('previewImages').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–§–∞–π–ª—ã –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    if (previewMode === 'images') {
        loadPreviewsFromBlobs(foundKeys);
    } else {
        showIdList(foundKeys);
    }
}

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –ü–†–ï–í–¨–Æ –ò–ó BLOB'–û–í
function loadPreviewsFromBlobs(keys) {
    const previewContainer = document.getElementById('previewImages');
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ..." –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    if (previewContainer.innerHTML.includes('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ')) {
        previewContainer.innerHTML = '';
    }
    
    let html = '';
    let loadedCount = 0;

    // üîß –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê –ü–û ID
    const sortedKeys = [...keys].sort((a, b) => {
        const getNumericId = (key) => {
            const match = key.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        };
        return getNumericId(a) - getNumericId(b);
    });

    sortedKeys.forEach(key => {
        const imageData = foundImages.get(key);
        
        if (imageData && imageData.blobUrl) {
            html += `
                <div class="preview-image" data-id="${key}">
                    <img src="${imageData.blobUrl}" alt="${CONTENT_TYPES[currentScanType].name} #${imageData.id}">
                    <div class="image-info">
                        <div class="image-id">#${imageData.id}${imageData.version ? ` (v${imageData.version})` : ''}</div>
                        <div>${CONTENT_TYPES[currentScanType].name}</div>
                        <div style="font-size: 10px; color: #666;">${imageData.size} –±–∞–π—Ç</div>
                    </div>
                </div>
            `;
            loadedCount++;
        }
    });

    if (loadedCount > 0) {
        previewContainer.innerHTML = html;
    } else {
        previewContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–≤—å—é</div>';
    }
}

// üîß –§–ò–ö–° –ë–´–°–¢–†–û–ì–û –°–¢–ê–†–¢–ê
function quickTest() {
    document.getElementById('startId').value = 1;
    document.getElementById('endId').value = 20;
    document.getElementById('delay').value = 100;
    
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í—ã–∑—ã–≤–∞–µ–º startScan() –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    startScan();
}

        // üîß –≠–ö–°–ü–û–†–¢ –° –ü–û–î–î–ï–†–ñ–ö–û–ô –§–û–†–ú–ê–¢–û–í –ò–ú–ï–ù
        async function exportResults() {
            const actualFileCount = foundImages.size;
            if (actualFileCount === 0) {
                alert('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            addLog(`üíæ –ù–∞—á–∏–Ω–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç ${actualFileCount} —Ñ–∞–π–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ${exportFormat.toUpperCase()}`, 'info');
            addLog(`üìù –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω: ${getFileNameFormatName()}`, 'info');

            switch(exportFormat) {
                case 'zip':
                    await exportAsZip();
                    break;
                case 'png':
                    await exportAsIndividualFiles('png');
                    break;
                case 'jpg':
                    await exportAsIndividualFiles('jpg');
                    break;
                case 'json':
                    exportAsJson();
                    break;
            }
        }

        // üîß –°–û–ó–î–ê–ù–ò–ï –ò–ú–ï–ù–ò –§–ê–ô–õ–ê –î–õ–Ø –≠–ö–°–ü–û–†–¢–ê
        function createExportFilename(data, format = null) {
            const id = data.id;
            const version = data.version;
            const actualFormat = format || CONTENT_TYPES[currentScanType].extension;
            
            let filename;
            
            switch(fileNameFormat) {
                case 'type_id':
                    filename = version ? 
                        `${currentScanType}_${id}_v${version}.${actualFormat}` : 
                        `${currentScanType}_${id}.${actualFormat}`;
                    break;
                case 'catwar_type_id':
                    filename = version ? 
                        `CatWar_${currentScanType}_${id}_v${version}.${actualFormat}` : 
                        `CatWar_${currentScanType}_${id}.${actualFormat}`;
                    break;
                case 'id_only':
                    filename = version ? 
                        `${id}_v${version}.${actualFormat}` : 
                        `${id}.${actualFormat}`;
                    break;
                default:
                    filename = version ? 
                        `${currentScanType}_${id}_v${version}.${actualFormat}` : 
                        `${currentScanType}_${id}.${actualFormat}`;
            }
            
            return filename;
        }

        async function exportAsZip() {
            try {
                const zip = new JSZip();
                let fileCount = 0;

                // üîß –°–û–†–¢–ò–†–û–í–ö–ê –ü–ï–†–ï–î –≠–ö–°–ü–û–†–¢–û–ú
                const sortedEntries = Array.from(foundImages.entries()).sort(([keyA], [keyB]) => {
                    const getNumericId = (key) => {
                        const match = key.match(/(\d+)/);
                        return match ? parseInt(match[1]) : 0;
                    };
                    return getNumericId(keyA) - getNumericId(keyB);
                });

                sortedEntries.forEach(([key, data]) => {
                    const filename = createExportFilename(data);
                    zip.file(filename, data.blob);
                    fileCount++;
                });

                addLog(`üì¶ –°–æ–∑–¥–∞–Ω–∏–µ ZIP-–∞—Ä—Ö–∏–≤–∞ —Å ${fileCount} —Ñ–∞–π–ª–∞–º–∏...`, 'info');

                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                });

                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const archiveName = `CatWar_${currentScanType}_${fileCount}files_${timestamp}.zip`;

                saveAs(content, archiveName);
                showArchiveSuccess(archiveName, fileCount, content.size);
                addLog(`‚úÖ ZIP-–∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${archiveName} (${fileCount} —Ñ–∞–π–ª–æ–≤)`, 'success');

            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: ${error.message}`, 'error');
            }
        }

        async function exportAsIndividualFiles(format) {
            let exportedCount = 0;

            // üîß –°–û–†–¢–ò–†–û–í–ö–ê –ü–ï–†–ï–î –≠–ö–°–ü–û–†–¢–û–ú
            const sortedEntries = Array.from(foundImages.entries()).sort(([keyA], [keyB]) => {
                const getNumericId = (key) => {
                    const match = key.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                };
                return getNumericId(keyA) - getNumericId(keyB);
            });

            for (const [key, data] of sortedEntries) {
                try {
                    const filename = createExportFilename(data, format);
                    
                    let exportBlob = data.blob;
                    if (format === 'jpg' && data.blob.type === 'image/png') {
                        exportBlob = await convertToJpg(data.blob);
                    }
                    
                    saveAs(exportBlob, filename);
                    exportedCount++;
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
                }
            }

            showArchiveSuccess(`–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (${format.toUpperCase()})`, exportedCount, 0);
            addLog(`‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportedCount} —Ñ–∞–π–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ${format.toUpperCase()}`, 'success');
        }

        function exportAsJson() {
            const actualFileCount = foundImages.size;
            const exportData = {
                type: currentScanType,
                name: CONTENT_TYPES[currentScanType].name,
                domain: currentDomain,
                fileNameFormat: fileNameFormat,
                timestamp: new Date().toISOString(),
                totalFiles: actualFileCount,
                found: Array.from(foundImages.values())
                    .sort((a, b) => a.id - b.id)
                    .map(data => ({
                        id: data.id,
                        version: data.version,
                        url: data.url,
                        filename: createExportFilename(data),
                        size: data.blob.size,
                        type: data.blob.type
                    }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `CatWar_${currentScanType}_${actualFileCount}items_${timestamp}.json`;

            saveAs(blob, filename);
            showArchiveSuccess(filename, actualFileCount, blob.size);
            addLog(`‚úÖ JSON —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: ${filename} (${actualFileCount} —Ñ–∞–π–ª–æ–≤)`, 'success');
        }

        async function convertToJpg(pngBlob) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(blob) {
                        resolve(blob);
                    }, 'image/jpeg', 0.9);
                };
                
                img.src = URL.createObjectURL(pngBlob);
            });
        }

        function showArchiveSuccess(filename, fileCount, fileSize) {
            const archiveSuccess = document.getElementById('archiveSuccess');
            const archiveInfo = document.getElementById('archiveInfo');
            
            let infoText = `
                <strong>–§–∞–π–ª:</strong> ${filename}<br>
                <strong>–§–∞–π–ª–æ–≤:</strong> ${fileCount}<br>
                <strong>–§–æ—Ä–º–∞—Ç –∏–º–µ–Ω:</strong> ${getFileNameFormatName()}
            `;
            
            if (fileSize > 0) {
                infoText += `<br><strong>–†–∞–∑–º–µ—Ä:</strong> ${formatFileSize(fileSize)}`;
            }
            
            archiveInfo.innerHTML = infoText;
            archiveSuccess.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        function getProxyUrl(url) {
            const proxyBase = CORS_PROXIES[currentProxyIndex];
            const separator = proxyBase.includes('?') ? '&' : '?';
            return proxyBase + encodeURIComponent(url);
        }

        function rotateProxy() {
            currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
        }

        function updateProgress(current, total) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${current}/${total}`;
            document.getElementById('statusText').textContent = `–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ${CONTENT_TYPES[currentScanType].name}...`;
        }

        function updateStats() {
            document.getElementById('checkedCount').textContent = totalChecked;
            document.getElementById('foundCount').textContent = totalFound;
            
            const successRate = totalChecked > 0 ? Math.round((totalFound / totalChecked) * 100) : 0;
            document.getElementById('currentSuccessRate').textContent = successRate + '%';
        }

        function updateGlobalStats() {
            document.getElementById('totalScanned').textContent = globalStats.totalScanned;
            document.getElementById('totalFound').textContent = globalStats.totalFound;
            
            const successRate = globalStats.totalScanned > 0 ? Math.round((globalStats.totalFound / globalStats.totalScanned) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('lastScan').textContent = new Date().toLocaleDateString();
        }

        function updateDetailedStats() {
            document.getElementById('statsTotalScanned').textContent = globalStats.totalScanned;
            document.getElementById('statsTotalFound').textContent = globalStats.totalFound;
            
            const successRate = globalStats.totalScanned > 0 ? Math.round((globalStats.totalFound / globalStats.totalScanned) * 100) : 0;
            document.getElementById('statsSuccessRate').textContent = successRate + '%';
            
            const avgSpeed = globalStats.totalTime > 0 ? Math.round(globalStats.totalScanned / globalStats.totalTime) : 0;
            document.getElementById('statsAvgSpeed').textContent = avgSpeed + '/—Å';
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>